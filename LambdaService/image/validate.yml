parameters:
- name: directory
  type: string
- name: buildImage
  type: string
  default: ''

steps:  
- checkout: self
  submodules: true

- script: |
    runtime=$(grep -Po 'FROM \K[^:]*' $dockerfilePath | xargs -L 1 basename)
    echo "Checking Dockerfile at: ${dockerfilePath}"
    echo "Setting Runtime: ${runtime}"
    echo "##vso[task.setvariable variable=value;isOutput=true]${runtime}"
  displayName: Get Runtime
  name: GetRuntime
  env:
    dockerfilePath: ${{ coalesce(parameters.buildImage, format('{0}/{1}', parameters.directory, 'Dockerfile')) }}

- task: npmAuthenticate@0
  inputs:
    workingFile: '${{ parameters.directory }}/.npmrc'

- task: Docker@2
  inputs:
    command: build
    buildContext: '${{ parameters.directory }}'
    Dockerfile: 'dockerfiles/lambda/nodejs/Dockerfile'
    repository: ${{ lower(parameters.directory) }}
    tags: latest
    arguments: '--secret id=npmrc-package,src=${{ parameters.directory }}/.npmrc'
  env:
    DOCKER_BUILDKIT: 1